<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sbitech.mapper.PermissionMapper">

    <!-- 根据角色ID查询权限列表 -->
    <select id="findPermissionsByRoleId" resultType="com.sbitech.entity.Permission">
        SELECT DISTINCT p.id, p.permission_code, p.permission_name, p.description
        FROM permission p
        INNER JOIN role_permission rp ON p.id = rp.permission_id
        WHERE rp.role_id = #{roleId}
        ORDER BY p.id
    </select>

    <!-- 根据裁判ID查询权限列表（包括角色权限和个人权限） -->
    <select id="findPermissionsByRefereeId" resultType="com.sbitech.entity.Permission">
        SELECT DISTINCT p.id, p.permission_code, p.permission_name, p.description
        FROM permission p
        WHERE p.id IN (
            -- 角色权限
            SELECT rp.permission_id
            FROM role_permission rp
            INNER JOIN referee r ON r.role_id = rp.role_id
            WHERE r.id = #{refereeId}
            UNION
            -- 个人权限
            SELECT refp.permission_id
            FROM referee_permission refp
            WHERE refp.referee_id = #{refereeId} AND refp.is_enabled = true
        )
        ORDER BY p.id
    </select>

</mapper>